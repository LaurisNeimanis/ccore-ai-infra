flowchart TD

    %% =========================
    %% LAYERS
    %% =========================

    subgraph L0["Operator"]
        OP["Operator / Developer"]
    end

    subgraph L1["Terraform Layer"]
        TF_APPLY["Terraform Apply (envs/dev)"]
        MOD_VPC["terraform-aws-modules/vpc"]
        MOD_SG["terraform-aws-modules/security-group"]
        MOD_EC2["modules/ec2-instance (custom)<br/>AMI lookup + cloud-init (bootstrap.yaml)"]
        INV_FILE["ansible/inventory/hosts.yaml<br/>(generated via local_file)"]
    end

    subgraph L2["AWS Infrastructure"]
        VPC["VPC"]
        SUBNET["Public Subnet"]
        IGW["Internet Gateway"]
        RT["Route Table"]
        SG_AWS["Security Group"]
        EC2["EC2 Instance (Ubuntu 24.04)"]
    end

    subgraph L3["Bootstrap Layer"]
        CI_BOOT["cloud-init Bootstrap (bootstrap.yaml)"]
        READY["Instance Ready<br/>Python3 Installed + SSH + cloud-init done"]
    end

    subgraph L4["Ansible Layer"]
        APB["Ansible Playbook"]
        ROLE_DOCKER["Role: docker<br/>Install Docker Engine + Compose"]
        ROLE_APP["Role: app_deploy<br/>Render templates + pull GHCR images"]
    end

    subgraph L5["Application Layer (Docker)"]
        COMPOSE["/opt/ccore-ai/ Docker Compose Stack"]
        BACKEND["Backend Container (GHCR)"]
        FRONTEND["Frontend Container (GHCR)"]
        NGINX["Nginx Reverse Proxy"]
        HTTP["Public HTTP Endpoint (Port 80)"]
    end

    %% =========================
    %% FLOWS
    %% =========================

    OP --> TF_APPLY
    OP --> APB

    TF_APPLY --> MOD_VPC
    TF_APPLY --> MOD_SG
    TF_APPLY --> MOD_EC2
    TF_APPLY --> INV_FILE

    MOD_VPC --> VPC
    MOD_VPC --> SUBNET
    MOD_VPC --> IGW
    MOD_VPC --> RT

    MOD_SG --> SG_AWS

    MOD_EC2 --> EC2

    EC2 --> CI_BOOT
    CI_BOOT --> READY
    READY --> APB

    APB --> ROLE_DOCKER
    APB --> ROLE_APP

    ROLE_DOCKER --> COMPOSE
    ROLE_APP --> COMPOSE

    COMPOSE --> BACKEND
    COMPOSE --> FRONTEND
    COMPOSE --> NGINX

    NGINX --> HTTP
