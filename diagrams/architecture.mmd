flowchart TD

    %% =========================
    %% LAYERS
    %% =========================

    subgraph L0["Operator"]
        OP["Operator / Developer"]
    end

    subgraph L1["Terraform Layer"]
        TF_APPLY["Terraform Apply (envs/dev)"]
        MOD_NET["Network Module (VPC, Subnet, IGW, Route Table, SG)"]
        MOD_CMP["Compute Module (EC2, AMI lookup, KeyPair, bootstrap.sh)"]
        INV_FILE["ansible/inventory/hosts.yaml"]
    end

    subgraph L2["AWS Infrastructure"]
        VPC["VPC"]
        SUBNET["Public Subnet"]
        IGW["Internet Gateway"]
        RT["Route Table"]
        SG["Security Group"]
        EC2["EC2 Instance (Ubuntu 24.04)"]
    end

    subgraph L3["Bootstrap Layer"]
        CI_BOOT["cloud-init Bootstrap"]
        READY["Instance Ready for Ansible<br/>Python3 Installed + SSH + readiness marker"]
    end

    subgraph L4["Ansible Layer"]
        APB["Ansible Playbook (ansible/playbook.yml)"]
        ROLE_DOCKER["Role: docker<br/>Install Docker Engine + Compose"]
        ROLE_APP["Role: app_deploy<br/>Render templates + pull GHCR images"]
    end

    subgraph L5["Application Layer (Docker)"]
        COMPOSE["/opt/ccore-ai/ Docker Compose Stack"]
        BACKEND["Backend Container (GHCR image)"]
        FRONTEND["Frontend Container (GHCR image)"]
        NGINX["Nginx Reverse Proxy Container"]
        HTTPS["Public HTTPS Endpoint"]
    end

    %% =========================
    %% FLOWS
    %% =========================

    OP --> TF_APPLY
    OP --> APB

    TF_APPLY --> MOD_NET
    TF_APPLY --> MOD_CMP

    MOD_NET --> VPC
    MOD_NET --> SUBNET
    MOD_NET --> IGW
    MOD_NET --> RT
    MOD_NET --> SG

    MOD_CMP --> EC2
    VPC --> EC2
    SUBNET --> EC2
    SG --> EC2

    TF_APPLY --> INV_FILE

    EC2 --> CI_BOOT
    CI_BOOT --> READY

    APB --> INV_FILE
    APB --> ROLE_DOCKER
    APB --> ROLE_APP
    READY --> APB

    ROLE_DOCKER --> COMPOSE
    ROLE_APP --> COMPOSE

    COMPOSE --> BACKEND
    COMPOSE --> FRONTEND
    COMPOSE --> NGINX

    NGINX --> HTTPS
