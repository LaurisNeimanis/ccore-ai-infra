# Ansible Configuration -- ccore-ai-infra

This directory contains the **post-provision configuration layer** for
the EC2 instance created by Terraform.

Terraform provisions infrastructure → cloud-init prepares the machine →
Ansible installs Docker and deploys the application stack using:

-   **pre-built GHCR images**
-   **templated configuration files** (`docker-compose.yml` and
    `nginx.conf`)

This ensures a clean, reproducible, pull-based deployment model.

------------------------------------------------------------------------

## 1. Directory Structure

    ansible/
    ├── inventory/
    │   └── hosts.yaml                       # Auto-generated by Terraform
    │
    ├── roles/
    │   ├── docker/                          # Docker Engine installation
    │   │   └── tasks/main.yml
    │   │
    │   └── app_deploy/                      # Application deployment (GHCR + Compose)
    │       ├── tasks/main.yml
    │       └── templates/
    │           ├── docker-compose.yml.j2    # Defines stack (backend, frontend, nginx)
    │           └── nginx.conf.j2            # Nginx reverse proxy config
    │
    └── playbook.yml

Notes:

-   No Python source code is stored on the server.
-   No Dockerfiles exist here --- **all images come from GHCR**.
-   Both `docker-compose.yml` and `nginx.conf` are rendered from
    templates.

------------------------------------------------------------------------

## 2. Workflow Overview

### Terraform

- Creates AWS VPC, subnet, route table, security group
- Deploys EC2 instance
- Injects updated **cloud-init**:
  - updates apt
  - installs Python3 (required for Ansible)
  - ensures SSH is running
  - writes bootstrap marker  
- Generates Ansible inventory:

```
ansible/inventory/hosts.yaml
```

Example:

``` yaml
all:
  hosts:
    app:
      ansible_host: 3.120.88.15
      ansible_user: ubuntu
```

### Ansible

-   Installs Docker Engine and Docker Compose plugin
-   Creates directory `/opt/ccore-ai`
-   Renders:
    -   `/opt/ccore-ai/docker-compose.yml`
    -   `/opt/ccore-ai/nginx/nginx.conf`
-   Pulls GHCR container images:
    -   backend: `ghcr.io/laurisneimanis/ccore-ai-demo-backend:latest`
    -   frontend: `ghcr.io/laurisneimanis/ccore-ai-demo-frontend:latest`
-   Starts full stack:

```
docker compose -f /opt/ccore-ai/docker-compose.yml up -d
```

Deployment is **idempotent** --- safe to run anytime.

------------------------------------------------------------------------

## 3. Running Provisioning

### Step 1 --- Terraform deploy

    cd terraform/envs/dev
    terraform apply

### Step 2 --- Ansible provisioning

    ansible-playbook -i ansible/inventory/hosts.yaml ansible/playbook.yml

Result:

-   Docker installed
-   docker-compose.yml + nginx.conf rendered
-   GHCR images pulled
-   Stack running under `/opt/ccore-ai`

------------------------------------------------------------------------

## 4. Roles

### docker

Installs:

-   docker-ce
-   docker-ce-cli
-   containerd.io
-   docker-compose-plugin

Enables Docker and adds the EC2 `ubuntu` user to the `docker` group.

### app_deploy

Responsible for application-level configuration:

-   Creates `/opt/ccore-ai`
-   Renders compose + nginx templates
-   Pulls container images from GHCR
-   Runs:

```
docker compose up -d
```

No builds. No source code. Pure pull-based deployment.

------------------------------------------------------------------------

## 5. Architecture Diagram

``` mermaid
flowchart TD
    A[Terraform Apply] --> B[VPC + Subnet + SG + Route Table]
    A --> C[EC2 Instance]
    A --> D[Generate hosts.yaml]

    C --> E[cloud-init bootstrap]
    E --> F[Ansible Playbook]

    F --> G[Docker Install Role]
    F --> H[Render docker-compose + nginx.conf]

    H --> I[Docker Compose Stack]
    I --> J[Backend + Frontend + Nginx Containers]
```

------------------------------------------------------------------------

## 6. Linting & Quality Checks

The Ansible layer is validated with strict linting tools:

### Local linting

```
yamllint ansible/
ansible-lint ansible/
```

The repository includes `.yamllint` configuration:

- `document-start` disabled (no need for `---`)
- strict truthy checking (`true/false` only)

------------------------------------------------------------------------

## 7. Good Practices Applied

-   Pull-based server deployment (no local builds)
-   Clean separation: Terraform → Infra, Ansible → Config, GHCR → Images
-   No hardcoded IPs (inventory autogenerated)
-   Idempotent roles
-   Clear directory structure under `/opt/ccore-ai`
-   Reproducible, minimal, production-style workflow

------------------------------------------------------------------------

## 8. Summary

This Ansible layer provides:

- Clean post-provision EC2 configuration  
- Deterministic deployment using GHCR images  
- Templated configuration (Compose + Nginx)  
- Automated linting and validation  
- Fully working containerized stack  

All tightly aligned with the broader **ccore-ai** infrastructure workflow.
