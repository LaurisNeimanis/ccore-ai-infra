---
- name: Ensure base app directory exists
  file:
    path: /opt/app
    state: directory
    mode: "0755"

- name: Create nginx directories
  file:
    path: /opt/app/nginx/certs
    state: directory
    mode: "0755"
    recurse: yes

- name: Generate self-signed SSL certificate
  command: >
    openssl req -x509 -nodes -days 365
    -subj "/CN=localhost"
    -newkey rsa:2048
    -keyout /opt/app/nginx/certs/self.key
    -out /opt/app/nginx/certs/self.crt
  args:
    creates: /opt/app/nginx/certs/self.crt

- name: Deploy nginx.conf from template
  template:
    src: nginx.conf.j2
    dest: /opt/app/nginx/nginx.conf
    mode: "0644"

- name: Create python demo app directory
  file:
    path: /opt/app/python-demo-app
    state: directory
    mode: "0755"

- name: Deploy Python demo app Dockerfile
  template:
    src: Dockerfile.j2
    dest: /opt/app/python-demo-app/Dockerfile
    mode: "0644"

- name: Copy python demo app build context
  copy:
    src: "{{ role_path }}/files/"
    dest: /opt/app/python-demo-app/
    mode: "0644"

- name: Deploy docker-compose.yml from template
  template:
    src: docker-compose.yml.j2
    dest: /opt/app/docker-compose.yml
    mode: "0644"

- name: Ensure docker compose plugin installed
  apt:
    name: docker-compose-plugin
    state: present
    update_cache: yes

- name: Restart Docker service after plugin install
  systemd:
    name: docker
    state: restarted

- name: Start / update stack with Docker Compose
  command: /usr/bin/docker compose up -d --build
  args:
    chdir: /opt/app
