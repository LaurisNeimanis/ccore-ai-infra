---
# ============================
# Base directories
# ============================
- name: Ensure app directory exists
  file:
    path: /opt/ccore-ai
    state: directory
    mode: "0755"

- name: Ensure nginx directories exist
  file:
    path: /opt/ccore-ai/nginx/certs
    state: directory
    mode: "0755"
    recurse: yes

# ============================
# Self-signed cert generation (only if missing)
# ============================
- name: Check if SSL certificate exists
  stat:
    path: /opt/ccore-ai/nginx/certs/self.crt
  register: cert_exists

- name: Check if SSL key exists
  stat:
    path: /opt/ccore-ai/nginx/certs/self.key
  register: key_exists

- name: Generate self-signed certificate (only if missing)
  command: >
    openssl req -x509 -nodes -days 365
    -newkey rsa:2048
    -keyout /opt/ccore-ai/nginx/certs/self.key
    -out /opt/ccore-ai/nginx/certs/self.crt
    -subj "/C=LV/ST=LV/L=Liepaja/O=CyberTech/OU=DevOps/CN=demo.local"
  when: not cert_exists.stat.exists or not key_exists.stat.exists
  register: ssl_change

# ============================
# Deploy templates
# ============================
- name: Deploy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: /opt/ccore-ai/docker-compose.yml
    mode: "0644"
  register: compose_file_change

- name: Deploy nginx.conf
  template:
    src: nginx.conf.j2
    dest: /opt/ccore-ai/nginx/nginx.conf
    mode: "0644"
  register: nginx_file_change

# ============================
# Docker Compose plugin
# ============================
- name: Gather package facts
  package_facts:
    manager: apt

- name: Install Docker Compose plugin if missing
  apt:
    name: docker-compose-plugin
    state: present
    update_cache: yes
  when: "'docker-compose-plugin' not in ansible_facts.packages"
  register: compose_install

# ============================
# Restart Docker (ONLY if needed)
# ============================
- name: Restart Docker service
  systemd:
    name: docker
    state: restarted
  when: compose_install.changed

# ============================
# Start stack (ONLY if something changed)
# ============================
- name: Start stack with Docker Compose
  command: docker compose -f /opt/ccore-ai/docker-compose.yml up -d
  args:
    chdir: /opt/ccore-ai
  when: >
    compose_file_change.changed or
    nginx_file_change.changed or
    ssl_change.changed or
    compose_install.changed
